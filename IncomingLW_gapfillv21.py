
import pandas as pd
import numpy as np
import os
import datetime as dt
from scipy import stats
from scipy.optimize import curve_fit

#Import custom code for processing
import Gap_Fill_climatology_v2 as gap_fill_climatology
import meteorologicalfunctions as metfuncs
import gapfill_utilities_v2 as gf
import pdb

###### Functions ######

# Modified Brutsaert equation
def LW_calc(array_test,a,b):
    return ((array_test[:,2]+(1-array_test[:,2])* # Cloud factor addition to Brutsaert emissivity
            (a*((array_test[:,1]*10)/(array_test[:,0]+273.15))**b))* # Brutsaert emissivity
            (5.67/10**8)*(array_test[:,0]+273.15)**4)   # Stefan Boltzmann

def find_nearest(dateObj):
    ind=pd.date_range(dateObj,periods=1440/rec_length,freq=freq_str)
    NearDays_DF=abs(DaySum_DF_global['Obs_LW']-DaySum_DF_global['LW_est'][dateObj])
    NearDays_DF.sort()
    NearDays_DF=NearDays_DF[:10]
    NearData_DF=pd.concat([LW_DF_global[VarToProcess][dt.datetime.strftime(j,'%Y-%m-%d')] for j in NearDays_DF.index])
    temp_DF=NearData_DF.groupby([lambda x: x.hour,lambda y: y.minute]).mean()
    temp_DF.index=ind
    return temp_DF

def Fld_gapfill(variable_to_fill,myBaseforResults,mypathforAWAPdata,FileName_AWAPData,FLUXDataframe,Site_ID,fluxfreq):


    ###### Set constants ######
    
    # Globals
    global VarToProcess
    VarToProcess=variable_to_fill
    global rec_length
    rec_length=int(fluxfreq[:2])
    global freq_str
    freq_str=fluxfreq
    
    # Locals
    groupby_string='week'  # Frequency of binning for climatology: dayofyear, week, month
    avail_data_threshold=30
    write_to_DF=True
              
          
    ###### Set I/O ######
    
    print "Starting Fld gap filling"
    #Check for place to put results - does it exist? If not create
    if not os.path.isdir(myBaseforResults):
	os.mkdir(myBaseforResults)
    #Then subdirectories
    if not os.path.isdir(myBaseforResults+"/ANCILLARY"):
	os.mkdir(myBaseforResults+"/ANCILLARY")
    mypathforResults=myBaseforResults+"/ANCILLARY"  
    
    #AWAP ancillary data file location        
    InputPathName_AWAPData=os.path.join(mypathforAWAPdata,FileName_AWAPData)
    varNames_AWAP=['YYYY','MM','DD','T_9am','T_3pm','e_9am','e_3pm']
    
    #Cloud factor ancillary data file
    InputPathName_CLFData=mypathforResults+'/Daily Solar Calculations AWAP and Obs for '+Site_ID+'.csv'
    varNames_CLF=['DT','Cloud_factor']    
    
    #Booleans specifying whether AWAP or BOM data is available
    AWAP_avail=os.path.exists(InputPathName_AWAPData)
    
    #Get start and end dates for data
    date_list=[FLUXDataframe.index[0],FLUXDataframe.index[-1]]

    #Specify the variables for later analysis    
    var_list=['Obs_Ta','Obs_E','Obs_LW']
                   
    ###### Calculate daily averages for obs ######
    
    #Create vapour pressure variable in DF
    FLUXDataframe['E']=metfuncs.vapourpressure(FLUXDataframe['Ah_Con'],FLUXDataframe['Ta_Con'])   
       
    #Average observational met data
    by = lambda x: lambda y: getattr(y, x)
    DaySum_DF=pd.DataFrame({
                'Obs_Ta':FLUXDataframe['Ta'].groupby([by('year'),by('dayofyear')]).mean(),
                'ObsTa_count':FLUXDataframe['Ta'].groupby([by('year'),by('dayofyear')]).count(),
                'Obs_E':FLUXDataframe['E'].groupby([by('year'),by('dayofyear')]).mean()*10,
                'ObsE_count':FLUXDataframe['E'].groupby([by('year'),by('dayofyear')]).count(),
                'Obs_LW':FLUXDataframe['Fld'].groupby([by('year'),by('dayofyear')]).mean(),
                'ObsLW_count':FLUXDataframe['Fld'].groupby([by('year'),by('dayofyear')]).count(),
                }).reset_index()

    #Drop sums with n<1440/rec_length, insert NaN for others and put into AWAP_DF
    DaySum_DF['Obs_Ta']=np.where(DaySum_DF['ObsTa_count']==1440/rec_length,DaySum_DF['Obs_Ta'],np.nan)
    DaySum_DF['Obs_E']=np.where(DaySum_DF['ObsE_count']==1440/rec_length,DaySum_DF['Obs_E'],np.nan)

    #Generate dates from group names (year and day of year)
    DaySum_DF.index=(DaySum_DF.apply(lambda x: dt.datetime.strptime(str(int(x['level_0']))+
                    '-'+str(int(x['level_1'])),'%Y-%j').date(), axis=1))    
            
    #Force AWAP_DF to cover full range of obs data (if it doesn't, missing dates will be filled with climatology below)
#    DaySum_DF=DaySum_DF.reindex(pd.date_range(FLUXDataframe.index[0].date()-dt.timedelta(days=1),
#                                              FLUXDataframe.index[-1].date()+dt.timedelta(days=1),freq='D'))          

        ###### Import data ######
    
    #Read in the cloud_factor csv file, use names assigned above
    CLF_DF=pd.read_csv(InputPathName_CLFData,sep=',',usecols=varNames_CLF,parse_dates=[0],index_col=varNames_CLF[0])
           
    #Put it in the daily data frame
    DaySum_DF=DaySum_DF.join(CLF_DF,how='left')
    
    #Add variable name to variable list
    var_list.append(varNames_CLF[1])
    
    # Import AWAP data if available
    if AWAP_avail:
                
        #Read in the AWAP csv file, ignore header, use names assigned above
        AWAP_DF=(pd.read_csv(InputPathName_AWAPData,header=None,names=varNames_AWAP,skiprows=2,na_values=['-9999'],
                keep_default_na=True,usecols=[0,1,2,4,5,7,8],parse_dates=[[0,1,2]],keep_date_col=True,index_col=0))
        AWAP_DF.replace(-9999,np.nan,inplace=True) #Get rid of -9999's
    
        #Check whether the dates of the files overlap
        try:

            print ('AWAP data available... percentage of AWAP data available between start and end dates of observational time series = '+
                   str(float(len(AWAP_DF.ix[date_list[0]:date_list[1]].dropna(how='any',axis=0)))/len(AWAP_DF.ix[date_list[0]:date_list[1]])*100))
                      
        except:
            
            print 'Dates in AWAP file do not overlap with dates for gap filling - excluding AWAP'    
            AWAP_avail=False
        
        else:
            
            #Average 9am and 3pm obs
            AWAP_DF['AWAPT_mean']=(AWAP_DF['T_9am']+AWAP_DF['T_3pm'])/2
            AWAP_DF['AWAPe_mean']=(AWAP_DF['e_9am']+AWAP_DF['e_3pm'])/20
            
            #Drop all extraneous columns
            AWAP_DF=AWAP_DF[['AWAPT_mean','AWAPe_mean']]

            
            #Merge the AWAP data into the daily dataframe
            DaySum_DF=DaySum_DF.join(AWAP_DF,how='left')         
            
            #drop nans first, then create two series for analysis and plotting
            temp_DF=DaySum_DF[['AWAPT_mean','Obs_Ta']].dropna(how='any',axis=0)
            xvalues=temp_DF['AWAPT_mean']
            yvalues=temp_DF['Obs_Ta']
            Ta_stats=stats.linregress(xvalues,yvalues)
            DaySum_DF['AWAPT_mean']=DaySum_DF['AWAPT_mean']*Ta_stats[0]+Ta_stats[1]
            temp_DF=DaySum_DF[['AWAPe_mean','Obs_E']].dropna(how='any',axis=0)
            xvalues=temp_DF['AWAPe_mean']
            yvalues=temp_DF['Obs_E']
            E_stats=stats.linregress(xvalues,yvalues)
            DaySum_DF['AWAPe_mean']=DaySum_DF['AWAPe_mean']*E_stats[0]+E_stats[1]
            
            #Print regression stats 
            print 'Regression stats (T_Obs/T_AWAP): slope=' + str(round(Ta_stats[0],3)) + ', int=' + str(round(Ta_stats[1],3)) + ' r-squared=' + str(round(Ta_stats[2],3))
            print 'Regression stats (E_Obs/E_AWAP): slope=' + str(round(E_stats[0],3)) + ', int=' + str(round(E_stats[1],3)) + ' r-squared=' + str(round(E_stats[2],3))
    
            #Fill gaps in Obs with AWAP data
            DaySum_DF['Obs_Ta']=np.where(pd.isnull(DaySum_DF['Obs_Ta']),DaySum_DF['AWAPT_mean'],DaySum_DF['Obs_Ta'])
            DaySum_DF['Obs_E']=np.where(pd.isnull(DaySum_DF['Obs_E']),DaySum_DF['AWAPe_mean'],DaySum_DF['Obs_E'])
            
            #Add AWAP variables to the variable list
            var_list.extend(['AWAPT_mean','AWAPe_mean'])            
            
                    
    ###### Drop extraneous columns and add a day of year column ######      

    DaySum_DF=DaySum_DF[var_list]             
    DaySum_DF['DOY']=DaySum_DF.index
    DaySum_DF['DOY']=((DaySum_DF['DOY'].apply(lambda x: int(dt.datetime.strftime(x,'%j')))))
    
    
    ##### Fill gaps in temperature and water vapour columns ######
    
    #Call function
    DaySum_DF=DaySum_DF.join(gf.fill_daily(DaySum_DF['Obs_Ta'],groupby_string))
    DaySum_DF=DaySum_DF.join(gf.fill_daily(DaySum_DF['Obs_E'],groupby_string))

    #Fill gaps in Obs with AWAP data
    DaySum_DF['Obs_Ta']=np.where(pd.isnull(DaySum_DF['Obs_Ta']),DaySum_DF['Obs_Ta_climatol'],DaySum_DF['Obs_Ta'])
    DaySum_DF['Obs_E']=np.where(pd.isnull(DaySum_DF['Obs_E']),DaySum_DF['Obs_E_climatol'],DaySum_DF['Obs_E'])  


    ###### Optimisation and calculation of estimated daily incoming longwave radiation ######         

    # Check if LW data present, then if so check how much
    if VarToProcess in FLUXDataframe.columns:
        
        avail_data=round(float(FLUXDataframe[VarToProcess].count())/len(FLUXDataframe)*100,2)
        
        if avail_data>avail_data_threshold:
            
            proc_var=True #Enable processing variable
            print 'Fitting Brutsaert coefficients... (Data available = ' + str(avail_data) + '%, minimum data threshold passed, set to = ' + str(avail_data_threshold) + '%)'
            
            #Create arrays to pass to optimisation algorithm
            opt_array=np.array(DaySum_DF[['Obs_Ta','Obs_E','Cloud_factor','Obs_LW']])
            opt_array=opt_array[~np.isnan(opt_array).any(axis=1)]
            
            #Optimise Brutsaert coefficients
            coeffs_opt,cov_opt=curve_fit(LW_calc,opt_array[:,0:3],opt_array[:,3],p0=(1,0.5))
    
        else:
            proc_var=False 
            print 'Setting default Brutsaert coefficients... (Data available = ' + str(avail_data) + '%, minimum data threshold failed, set to = ' + str(avail_data_threshold) + '%)'
                       
    else: proc_var=False
        
    if not proc_var: coeffs_opt=[1.24,0.17] #If no or too few longwave obs, just use the original Brutsaert coefficients
    
                                    
    #Spit out stats
    print 'Ldown=Epsilon*5.67*10^-8*T^4'
    print 'Epsilon=CLF+(1-CLF)*a(E/T)^b'
    print 'Where - a and b are Brutsaert coefficients: a='+str(round(coeffs_opt[0],3))+', b='+str(round(coeffs_opt[1],3))
    print '      - CLF=cloud fraction (1-daily observed Kdown/clear sky estimated Kdown),'
    print '      - T=temperature in K, E=vapour pressure in hPa'
        
    #Calculate daily mean longwave radiation for each day in series
    DaySum_DF['LW_est']=LW_calc(np.array(DaySum_DF[['Obs_Ta','Obs_E','Cloud_factor']]),coeffs_opt[0],coeffs_opt[1])
   
    ###### Create globals ######
    
    global LW_DF_global
    LW_DF_global=FLUXDataframe#[VarToProcess]
    global DaySum_DF_global                              
    DaySum_DF_global=DaySum_DF
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    ###### Get results and insert into new DF ######
    
    rslt_DF=pd.DataFrame({'Ldown_est':pd.concat([find_nearest(dateObj) for dateObj in DaySum_DF.index])},
                          index=pd.date_range(DaySum_DF.index[0].date(),periods=len(DaySum_DF)*(1440/rec_length),freq=fluxfreq))
    rslt_DF=rslt_DF.reindex(FLUXDataframe.index)
    
    
    ###### Generate output and return new variables ######

    write_to_DF=True
    if write_to_DF==True:
		
	#Create a new label for pandas df column for the contructed variable (and the QC flag) and column to fill label
	construct_label=str(VarToProcess+"_Con")
	FLUXDataframe[construct_label]=np.nan
	#add a column for the constructed QC flag
	#This will be 1 if valid data from the tower else 99
	construct_flag_label=str(VarToProcess+"_Con_QCFlag")
	FLUXDataframe[construct_flag_label]=np.nan
	#Create a series that is just the correlated output of CABLE adjusted to Tower
	corr_label=str(VarToProcess+"_Corr")
	FLUXDataframe[corr_label]=np.nan	
	
	#Start by filling with valid  values from tower
	FLUXDataframe[construct_flag_label][FLUXDataframe[VarToProcess].notnull()]=1
	FLUXDataframe[construct_label][FLUXDataframe[VarToProcess].notnull()]=FLUXDataframe[VarToProcess]
	#Fill with series calculated here
	FLUXDataframe[construct_flag_label][FLUXDataframe[construct_flag_label].isnull()]=99
	
	FLUXDataframe[corr_label]=rslt_DF
	FLUXDataframe[construct_label][FLUXDataframe[construct_flag_label]==99]=FLUXDataframe[corr_label]
	
    ###########################################
    # Call function to do climatology gap fill#
    ###########################################
    
    FLUXDataframe=gap_fill_climatology.climatology_monthly_diurnal(FLUXDataframe,VarToProcess)    
    
    print "Finished Fld gapfilling returning DF"
    return FLUXDataframe
  
    